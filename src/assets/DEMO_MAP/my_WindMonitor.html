<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <meta http-equiv="refresh" content="180">
   <script language="Javascript" src="/static/data/javascript/jquery-3.5.1.min.js"></script>
   <link rel='stylesheet' type='text/css' href='/static/data/css/HiImpact.css'>
   <script src='/static/data/javascript/echarts/Taiwan_Map/iHazard_Rain/echarts_5.0.2.min.js'></script>
   <script type='text/javascript' src='/static/data/test/mfcqpf_web/DEMO_MAP/citys_towns.js'></script>
   <script type='text/javascript' src='/static/data/test/mfcqpf_web/DEMO_MAP/echarts_Map_functions.js'></script>
   <script type='text/javascript' src='/static/data/test/mfcqpf_web/DEMO_MAP/GISMAP_Taiwan_param.js'></script>
   <script type='text/javascript' src='/static/data/test/mfcqpf_web/DEMO_MAP/GISMAP_Taiwan_echarts_plot.js'></script>
   <link href='/static/data/javascript/echarts/Taiwan_Map/iRain_ObsValue/weather-icons-master/css/weather-icons-wind.css' rel='stylesheet'>
   <link href='/static/Limitless/assets/css/icons/icomoon/styles.css' rel='stylesheet' type='text/css'>
   <link href="/static/assets/css/lib/themify-icons.css" rel="stylesheet">
   <title>風力監測/iRain</title>
</head>

<body>
   <h3></h3>
   <div><table id="table"></table></div>

<script>
function padLeft(num, lenght){
   str=num.toString(); 
   if (str.length >= lenght){
      return str;
   }else{
      return padLeft("0" + str, lenght);
   };
};
Date.prototype.toYDHM=function(){return padLeft(this.getMonth()+1,2)+"月"+padLeft(this.getDate(),2)+"日 "+padLeft(this.getHours(),2)+"時"+padLeft(this.getMinutes(),2)+"分";};
Date.prototype.toDHM=function(){return padLeft(this.getDate(),2)+"日"+padLeft(this.getHours(),2)+"時"+padLeft(this.getMinutes(),2)+"分";};
Date.prototype.toHM=function(){return padLeft(this.getHours(),2)+":"+padLeft(this.getMinutes(),2);};
Date.prototype.toYMD_H=function(){return padLeft(this.getFullYear(),4)+padLeft(this.getMonth()+1,2)+padLeft(this.getDate(),2)+"_"+padLeft(this.getHours(),2)+padLeft(this.getMinutes(),2);};
Date.prototype.toYMDHM=function(){return padLeft(this.getFullYear(),4)+"-"+padLeft(this.getMonth()+1,2)+"-"+padLeft(this.getDate(),2)+"T"+padLeft(this.getHours(),2)+":"+padLeft(this.getMinutes(),2);};
Date.prototype.toYMD=function(){return padLeft(this.getFullYear(),4)+padLeft(this.getMonth()+1,2)+padLeft(this.getDate(),2)};
Date.prototype.toYM=function(){return padLeft(this.getFullYear(),4)+padLeft(this.getMonth()+1,2)};
function getValue(varname){
   var url=window.location.href;
   if(url.indexOf("?")==-1){return "";}; 
   var qparts=url.split("?"); 
   if(qparts.length==0){return "";};
   var query=qparts[1]; 
   var vars=query.split("&"); 
   var value=""; 
   for(i=0;i<vars.length;i++){
      var parts = vars[i].split("="); 
      if(parts[0]==varname){
         value=parts[1]; 
         break;
      };
   }; 
   value=unescape(value); 
   value.replace(/\+/g," "); 
   return value;
};
function getUrlVars(){
   var vars={}; 
   var parts=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value){vars[key]=value;}); 
   return vars;
};
emptyArray=function(n,val="-"){
   var x=new Array(); 
   for(var i=0; i<n; i++){
      x.push(val)
   }; 
   return x
};
transport=array => array.reduce((r, a) => a.map((v, i) => [...(r[i] || []), v]), [])


set_color=(wind,gust)=>(wind>=12||gust>=14||gust==">17")?"indigo":(wind>=10||gust>=13)?"fuchsia":(wind>=8||gust>=11)?"red":(wind>=7||gust>=10)?"orange":(wind>=6||gust>=9)?"yellow":(wind>=5||gust>=7)?"aquamarine":(wind>=4||gust>=6)?"lightcyan":(wind<100.||gust<100.)?"none":"silver"
set_color2val=(mcls)=>(mcls=="indigo")?"7":(mcls=="fuchsia")?"6":(mcls=="red")?"5":(mcls=="orange")?"4":(mcls=="yellow")?"3":(mcls=="aquamarine")?"3":(mcls=="lightcyan")?"2":(mcls=="silver")?"0":"0"

ms2scale=function(WS){
   if(!isFinite(WS)||WS<0){
      return "-"
   }else if(WS<0.3){
      return 0
   }else if(WS<1.6){
      return 1
   }else if(WS<3.4){
      return 2
   }else if(WS<5.5){
      return 3
   }else if(WS<8.0){
      return 4
   }else if(WS<10.8){
      return 5
   }else if(WS<13.9){
      return 6
   }else if(WS<17.2){
      return 7
   }else if(WS<20.8){
      return 8
   }else if(WS<24.5){
      return 9
   }else if(WS<28.5){
      return 10
   }else if(WS<32.7){
      return 11
   }else if(WS<37.0){
      return 12
   }else if(WS<41.5){
      return 13
   }else if(WS<46.2){
      return 14
   }else if(WS<51.0){
      return 15
   }else if(WS<56.1){
      return 16
   }else if(WS<61.3){
      return 17
   }else if(WS<100.){
      return ">17"
   }else{
      return '-'
   };
};
set_font_wind=x=>x>=10?"cyan":x>=8?"black":x>=7?"gray":x>=6?"silver":"rgb(230,230,230)"
set_font_wind2=x=>x>=10?"cyan":x>=8?"black":x>=7?"gray":"silver"
set_font_gust=x=>x==">17"||x>=13?"cyan":x>=11?"black":x>=10?"gray":x>=8?"silver":"rgb(230,230,230)"
set_font_gust2=x=>x==">17"||x>=13?"cyan":x>=11?"black":x>=10?"gray":"silver"

deg2dir=function(dir){
   if(dir=="-"){
      return "-"
   }else{
      return ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"][parseInt((dir+dd/2.)/dd-1.)%16]
   };
};

h2ms=60*60*1.e3; 
m2ms=60*1.e3; 
obs_offset=4*m2ms; 
delta_t=10; //in minute

opacity=0.5; 
elev_threshold=350.; 
dd=360/16.
args=getUrlVars()
if(Object.keys(args).indexOf("date")==-1){
   now=new Date(); 
   now.setTime(now.getTime()-obs_offset); 
   now.setTime(now.getTime()-(now.getMinutes()%delta_t)*m2ms); 
   now.setSeconds(0,0,0);
}else{
   date=args.date; 
   now=new Date(parseInt(date.substr(0,4),10),
                parseInt(date.substr(4,2),10)-1,
                parseInt(date.substr(6,2),10),
                parseInt(date.substr(9,2),10),
                parseInt(date.substr(11,2),10),0,0);
};

t=new Date(); 
t.setTime(now.getTime()); 
file="/static/data/"+t.toYM()+"/OBS/OBSJSON/"+t.toYMD()+".json"; 
t.setTime(now.getTime()-24*h2ms); 
file0="/static/data/"+t.toYM()+"/OBS/OBSJSON/"+t.toYMD()+".json";

$.ajaxSetup({async: false});
$.when($.getJSON(file0),$.getJSON(file)).done(function(data1,data2){
   /********* JSON data structure **********
     x={"times":["YYYY-mm-DD HH:MM", ..., the length of times must meet the length of variable],
        "stids":{stid1:{"city":"花蓮市", "town":"玉里鎮", "elev":53, "lat":23.3, "lon":121.1, ...info of stid1}, stid2:{info of stid2},...},
        "variables":["vis10m","vis1m"... variables following...],
        "vis10m":{stid1:[...],stid2:[...],...}
        "vis1m":{stid1:[...],stid2:[...],...}
        ...
       }
   ***/
   params={"wind":["speed","dir","gust","times"]}; 
   n_minute = 0;  //n_minute: 10-minutely data to show; 
   n_hour   = 25; //n_hour:   hourly data to show 
   data=JSON.parse(JSON.stringify(data2[0])); 
   n2=data.times.length; 
   n1=data1[0].times.length; //alert(Object.keys(data))
   data.times=data1[0].times.concat(data.times);  
   Object.keys(data1[0].stids).forEach(function(key){
      if(Object.keys(data.stids).indexOf(key)==-1){
         data.stids[key]=data1[0].stids[key];
      };
   }); 
   data["stids"]["-"]={"name":"-","city":"-","town":"-","elev":"-", "stid5":"-", "lat":"-", "lon":"-"}
   Object.keys(data.stids).forEach(function(key){
      Object.keys(params).forEach(function(param){
         if(data1[0][param][key]==undefined && data[param][key]==undefined){return}
         params[param].forEach(function(param1){//alert(param+param1+key+data[param][key][param1])//alert(param+param1+key)
            if(data[param][key]==undefined){
               data[param][key]={}
            };
            if(data1[0][param][key]!=undefined && data[param][key][param1]==undefined){
                data[param][key][param1]=data1[0][param][key][param1].concat(emptyArray(n2));
            }else if(data1[0][param][key]==undefined && data[param][key][param1]!=undefined){
                data[param][key][param1]=emptyArray(n1).concat(data[param][key][param1]);
            }else{data[param][key][param1]=data1[0][param][key][param1].concat(data[param][key][param1])} 
         });
      });
   });
   console.log("data:",data)


   n=data.times.length;// alert(n+"-"+data.times[n-1])
   var t=new Date(data.times[n-1]); 
   if(now>t){
      now.setTime(t.getTime())
   };
   t0=new Date(); 
   t0.setTime(now.getTime()-n_minute*m2ms); 
   t0.setMinutes(0,0); 
   t00=new Date(); 
   t00.setTime(t0.getTime()-n_hour*h2ms);
   t_today=new Date(); 
   t_today.setTime(now.getTime()); 
   t_today.setHours(0,0,0); 
   if(t00.getTime()<(t_today.getTime()-24*h2ms)){
      t00.setTime(t_today.getTime()-24*h2ms)
   };
   $("h3").append("<font color=MediumVioletRed>風力監測(10分鐘資料)</font>")
   $("table").append("<thead><tr><th rowspan='2'>縣市</th><th rowspan='2'>鄉鎮市區</th></tr><tr></tr></thead>")
   i00     = data.times.indexOf(t00.toYMDHM()); /*25小時前*/
   i_start = data.times.indexOf( t0.toYMDHM()); /*最新時刻的10分鐘資料 Start*/ 
   i_end   = data.times.indexOf(now.toYMDHM()); /*最新時刻的10分鐘資料 End*/
   if(i_end==-1){
      i_end=n-1
   }; 
   i_today=data.times.indexOf(t_today.toYMDHM()); //alert(i00+"/"+i_start+"/"+i_end+"/"+n)
   for(var i=i00; i<i_start; i++){
      var t=new Date(data.times[i]); 
      if(t.getMinutes()!=0){continue}
      $("table>thead>tr:first").append("<th>"+t.getHours()+"<span>"+t.getDate()+"日"+t.getHours()+"時00-50分</span></th>");
      $("table>thead>tr:last").append("<th>00<span>"+t.getDate()+"日"+t.getHours()+"時00-50分</span></th>");
   }; 
   for(var i=i_start; i<=i_end; i++){
      var t=new Date(data.times[i]);
      if(t.getMinutes()==0){
         j=6; 
         if((now.getTime()-t.getTime())<60*m2ms){
            j=(parseInt(now.getTime()-t.getTime())/m2ms/delta_t)+1;
         }; 
         $("table>thead>tr:first").append("<th colspan='"+j+"'>"+t.getHours()+((j==1)?'':'時')+"<span>"+t.getDate()+"日"+t.getHours()+"時</span></th>");
      };
      $("table>thead>tr:last").append("<th>"+padLeft(t.getMinutes(),2)+"<span>"+t.getDate()+"日"+t.getHours()+"時"+padLeft(t.getMinutes(),2)+"分</span></th>");
   }; 

   $("table>thead>tr:first").append($("table>thead>tr:first>th:nth-child(2)").clone())
   $("table>thead>tr:first").append("<th colspan=3>目前("+now.toHM()+")風力</th><th colspan=2 style='background:rgba(25,25,112,0.7)'>前1時陣風</th><th colspan=4>今("+t_today.getDate()+")日最大風力<th style='background:rgba(25,25,112,0.7)' colspan=3>今("+t_today.getDate()+")日最大陣風</th></th>");
   $("table>thead>tr:last").append("<th>風力<span>ms<sup>-1</sup>(級)</th><th>風向</th><th>測站</th><th style='background:rgba(25,25,112,0.7)'>陣風<span>前1時陣風, ms<sup>-1</sup>(級)</span></th><th style='background:rgba(25,25,112,0.7)'>測站</th><th>風力<span>ms<sup>-1</sup>(級)</th><th>風向</th><th>測站</th><th>時間</th><th style='background:rgba(25,25,112,0.7)'>陣風<span>ms<sup>-1</sup>(級)</th><th style='background:rgba(25,25,112,0.7)'>測站</th><th style='background:rgba(25,25,112,0.7)'>時間</th>");
   $("table").append("<tfoot>"+$("table>thead").html()+"</tfoot>")

   param  = "wind"; 
   param1 = "speed"; 
   param2 = "dir"; 
   param3 = "gust"
   stids_of_town={}; 
   stids=[]; 
   stids_of_city={};
   cities.forEach(function(city){
      stids_of_town[city]={}; 
      stids_of_city[city]=[]; 
      towns[city].forEach(function(town){
         stids_of_town[city][town]=[]
      });
   }); //; alert(Object.keys(stids_of_town["臺北市"]["中正區"]))

   stids_of_town["其他"]["島嶼"]=["466950","C0B020","469020","468100","C0W160"]; 
   stids_of_town["其他"]["島嶼"].forEach(function(stid){
      if(Object.keys(data[param]).indexOf(stid)==-1){
         stids_of_town["其他"]["島嶼"].splice(stids_of_town["其他"]["島嶼"].indexOf(stid),1)
      };
   });
   Object.keys(data[param]).forEach(function(key){
      if(cities.indexOf(data['stids'][key].city)==-1||stids_of_town["其他"]["島嶼"].indexOf(key)!=-1){return}; 
      stids_of_town[data['stids'][key].city][data['stids'][key].town].push(key);
   });
   city="蘭嶼綠島"; 
   city1="臺東縣"; 
   Object.keys(stids_of_town[city]).forEach(function(town){
      stids_of_town[city][town]=stids_of_town[city1][town]; 
      delete stids_of_town[city1][town]; 
      towns[city1].splice(towns[city1].indexOf(town),1)
   });
   city="恆春半島"; 
   city1="屏東縣"; 
   Object.keys(stids_of_town[city]).forEach(function(town){
      stids_of_town[city][town]=stids_of_town[city1][town]; 
      delete stids_of_town[city1][town]; 
      towns[city1].splice(towns[city1].indexOf(town),1)
   });
   cities.forEach(function(city){
      towns[city].forEach(function(town){
         stids_of_city[city].push(...stids_of_town[city][town])
      });
   }); 
   none_towns=[]
   cities.forEach(function(city){
      length=stids_of_city[city].length
      stids=stids_of_city[city].filter(x=>Object.keys(data['stids']).indexOf(x)!=-1&&data['stids'][x].elev<=elev_threshold);
      var tmp1=[]; 
      stids.forEach(function(stid){
         tmp1.push(data[param][stid][param1]) /*Wind Speed*/
      }); 
      if(tmp1.length==0){
         tmp1=[emptyArray(n)]
      }; 
      tmp1=transport(tmp1)
      var tmp=tmp1.map(a=>Math.max.apply(null, a.filter(b=>isFinite(b))))
      var tmp2=[]; 
      stids.forEach(function(stid){
         tmp2.push(data[param][stid][param3]) /*Gust Wind*/
      }); 
      if(tmp2.length==0){
         tmp2=[emptyArray(n)]
      }; 
      tmp2=transport(tmp2)

      var tmpg=tmp2.map(a=>Math.max.apply(null, a.filter(b=>isFinite(b))))
      $("table").append("<tbody id='"+city+"'><tr><td class='city'>"+city+"</td><td class='town'>"+city+"</td></tr></tbody>")

      /* 從25小時前 - 現在時刻(in 10分鐘)  */
      for(var i=i00;i<=i_end;i++){
         var val  ='-'; 
         var dir  ='-'; 
         var gust ='-'; 
         var tim  ='-';
         var t=new Date(data.times[i]);
         /* 處理平均風 */
         if(i<i_start){
            if(t.getMinutes()!=0){continue}
            xx  = tmp.slice(i,i+6); 
            xxx = xx.filter(value=>isFinite(value)); 
            val = (xxx.length==0)?"-":Math.max.apply(null,xxx);
            if(val=="-"){
               dir="-"
            }else{
               j=xx.indexOf(val); 
               if(j!=-1){
                  j=j+i; 
                  jj=tmp1[j].indexOf(val); 
                  t=new Date(data.times[j]); 
                  stid=stids[jj]; 
                  dir=data[param][stid][param2][j];
               };
            };
         }else{ 
            val = tmp[i]; 
            dir = "-";
            try{
               jj=tmp1[i].indexOf(val); 
               stid=stids[jj]; 
               dir=data[param][stid][param2][i];
            }catch{} 
         };

         /* 處理陣風 */
         ii=(i+6)-(i+6)%6
         if(ii>=n){
            gust="-"; 
            tim="-"
         }else{
            gust=tmpg[ii]; 
            jj=tmp2[ii].indexOf(gust); 
            if(jj!=-1){
               stidg=stids[jj]; 
               tim=data[param][stidg]["times"][ii]
            }else{
               stidg="-"; 
               tim='-'
            };
         };

         if(val<0){
            val='-'; 
            dir='-'
         }; 
         if(gust<0){
            gust='-'
         }; 
         scale  = ms2scale(val); 
         scaleg = ms2scale(gust)
         cls    = set_color(scale,scaleg); 
         text=(isNaN(parseInt(val)))?"<span style='background-color:white;color:red;'>err!</span>":(((scale>=5)?"<font style='font-size:xx-small'><sup style='color:"+set_font_wind(scale)+"'>"+scale+"</sup><sub style='color:"+set_font_gust(scaleg)+"'>"+scaleg+"</sub></font>":"")+"<span style='background-color:white;'>"+scale+"G"+scaleg+", "+deg2dir(dir)+" "+val.toFixed(1)+" ms<sup>-1</sup> ("+scale+"級, "+t.toHM()+", "+data['stids'][stid].town+"-"+data['stids'][stid].name+")<br>陣風"+((gust=="-")?gust:(gust+' ms<sup>-1</sup>('+scaleg+'級, '+((tim=="-")?"-":(tim.slice(0,2)+':'+tim.slice(2)))+', '+((stidg=="-")?"-":(data['stids'][stidg].town+'-'+data['stids'][stidg].name)))+")")+"</span>")
         $("table>tbody#"+city+">tr:last").append("<td class='"+cls+"'>"+text+"</td>");

      }; 
      $("table>tbody#"+city+">tr:last").append($("table>tbody#"+city+">tr:last>td:nth-child(2)").clone())
      cls=set_color(scale,'-');
      ii=i_end-(i_end%6); 
      gust=tmpg[ii]; 
      jj=tmp2[ii].indexOf(gust); 
      if(jj!=-1){
         stidg=stids[jj]; 
         tim=data[param][stidg]["times"][ii]
      }else{
         stidg="-"; 
         tim='-'
      }; 
      scaleg=ms2scale(gust); 
      clsg=set_color('-',scaleg)

      if(val!="-"){
         $("table>tbody#"+city+">tr:last").append("<td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+val.toFixed(1)+" ("+scale+")</td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+deg2dir(dir)+"</td><td class='"+cls+"' style='font-size:smaller; color:"+set_font_wind2(scale)+"'>"+data['stids'][stid].name+"<span>"+data['stids'][stid].town+"</span></td>")
      }else{
         $("table>tbody#"+city+">tr:last").append("<td>-</td><td>-</td>><td>-</td>")
      };
      if(gust!="-"){
         $("table>tbody#"+city+">tr:last").append("<td class='"+clsg+"' style='color:"+set_font_gust2(scaleg)+"'>"+gust.toFixed(1)+" ("+scaleg+")</td><td class='"+clsg+"' style='font-size:smaller; color:"+set_font_gust2(scaleg)+"'>"+data['stids'][stidg].name+"<span>"+data['stids'][stidg].town+"</span></td>")
      }else{
         $("table>tbody#"+city+">tr:last").append("<td>-</td><td>-</td>")
      };
      $("table>tbody#"+city+">tr>td.town").addClass(set_color(scale,scaleg))
      val="-"; 
      tm=new Date(); 
      gust='-'; 
      tg=new Date()
      xx=tmp.slice(i_today,i_end+1); 
      xxx=xx.filter(value=>isFinite(value)); 
      val=(xxx.length==0)?"-":Math.max.apply(null,xxx);
      j=xx.indexOf(val); 
      if(j!=-1){
         j=j+i_today; 
         jj=tmp1[j].indexOf(val); 
         tm=new Date(data.times[j]); 
         stid=stids[jj];
      };
      xx=tmpg.slice(i_today,i_end+1); 
      xxx=xx.filter(value=>isFinite(value)); 
      gust=(xxx.length==0)?"-":Math.max.apply(null,xxx);
      j=xx.indexOf(gust); 
      if(j!=-1){
         j=j+i_today; 
         jj=tmp2[j].indexOf(gust); 
         stidg=stids[jj]; 
         tg=new Date(data.times[j]); 
         tim=data[param][stidg]["times"][j]; 
         tg.setHours(tim.slice(0,2),tim.slice(2))
      };
      scale=ms2scale(val); 
      cls=set_color(scale,'-'); 
      scaleg=ms2scale(gust); 
      clsg=set_color('-',scaleg)
      if(val!="-"){
         $("table>tbody#"+city+">tr:last").append("<td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+val.toFixed(1)+" ("+scale+")</td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+deg2dir(dir)+"</td><td class='"+cls+"' style='font-size:smaller; color:"+set_font_wind2(scale)+"'>"+data['stids'][stid].name+"<span>"+data['stids'][stid].town+"</span></td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+tm.toHM()+"</td>")
      }else{
         $("table>tbody#"+city+">tr:last").append("<td>-</td><td>-</td><td>-</td>-<td>-</td>")
      };
      if(gust!="-"){
         $("table>tbody#"+city+">tr:last").append("<td class='"+clsg+"' style='color:"+set_font_gust2(scaleg)+"'>"+gust.toFixed(1)+" ("+scaleg+")</td><td class='"+clsg+"' style='font-size:smaller; color:"+set_font_gust2(scaleg)+"'>"+data['stids'][stidg].name+"<span>"+data['stids'][stidg].town+"</span></td><td class='"+clsg+"' style='color:"+set_font_gust2(scaleg)+"'>"+tg.toHM()+"</td>")
      }else{
         $("table>tbody#"+city+">tr:last").append("<td class='none'>-</td><td>-</td>><td>-</td>")
      };
   });

   $("tbody>tr>td:first-child").each(function(){
      color=["rgb(245, 245, 255)","rgb(255,255,253)"][cities.indexOf($(this).text())%2]; 
      $(this).parent("tr").css("background-color",color)
   });
   $("table").after("<p><font color=black>Copyright © 2021-"+t.getFullYear()+" WFC, CWB</font> -<a href='https://www.cwb.gov.tw/'>Central Weather Bureau</a></p>")
   $("table").after("&nbsp;&nbsp;圖說：&nbsp;<i class='ti-control-stop' style='background-color:indigo;color:indigo'></i>&nbsp;&ge; 12G14&nbsp;&nbsp;<i class='ti-control-stop' style='background-color:fuchsia;color:fuchsia'></i>&nbsp;&ge; 10G13&nbsp;&nbsp;<i class='ti-control-stop' style='background-color:red;color:red'></i>&nbsp;&ge; 8G11&nbsp;&nbsp;<i class='ti-control-stop' style='background-color:orange;color:orange'></i>&nbsp;&ge; 7G10&nbsp;&nbsp;<i class='ti-control-stop' style='background-color:yellow;color:yellow;box-shadow: lightgray 0px 0px 1px 1px;'></i>&nbsp;&ge; 6G9&nbsp;&nbsp;<i class='ti-control-stop' style='background-color:aquamarine;color:aquamarine'></i>&nbsp;&ge; 5G7&nbsp;&nbsp;<i class='ti-control-stop' style='background-color:lightcyan;color:lightcyan;box-shadow: lightgray 0px 0px 1px 1px;'></i>&nbsp;&ge; 4G6&nbsp;&nbsp;<i class='ti-control-stop' style='background-color:lightgrey;color:lightgrey'></i>&nbsp;無資料&nbsp;&nbsp;")
   
   for(i=0; i<=n_minute; i++){
      idx=n_hour+(i*6); 
      $("tbody>tr>td:nth-child("+(idx+3)+")").each(function(){
         $(this).attr("style",$(this).attr("style")+";border-left:2px #85b1ff solid;")
      });
   };
   idx=parseInt((i_today-i00)/6); 
      if(idx>n_hour){
         idx=n_hour+(idx-n_hour)*6
      };
   $("tbody>tr>td:nth-child("+(idx+3)+")").each(function(){
      $(this).attr("style",$(this).attr("style")+";border-left:2px #bd87ff solid;")
   });
  
}).fail(function(){$("div").append("<h1>Loading Data Error!</h1>"); });






load_towns=function(city){
   $("table>tbody#"+city+">tr:nth-child(1)").css("opacity",opacity)
   towns[city].forEach(function(town){
      stids=stids_of_town[city][town].filter(x=>Object.keys(data['stids']).indexOf(x)!=-1&&data['stids'][x].elev<=elev_threshold); 
      length=stids.length; 
      length0=stids_of_town[city][town].length
      var tmp1=[]; 
      stids.forEach(function(stid){
         tmp1.push(data[param][stid][param1])
      }); 
      if(tmp1.length==0){
         tmp1=[emptyArray(n)]
      }; 
      tmp1=transport(tmp1)
      var tmp=tmp1.map(a=>Math.max.apply(null, a.filter(b=>isFinite(b))))
      var tmp2=[]; 
      stids.forEach(function(stid){
         tmp2.push(data[param][stid][param3])
      }); 
      if(tmp2.length==0){
         tmp2=[emptyArray(n)]
      }; 
      tmp2=transport(tmp2)
      var tmpg=tmp2.map(a=>Math.max.apply(null, a.filter(b=>isFinite(b))))
      if(tmp1.length==0){tmp=emptyArray(n)}; 
      if(tmp2.length==0){tmpg=emptyArray(n)}

      if(Object.keys(mountain_towns).indexOf(city)!=-1&&mountain_towns[city].indexOf(town)!=-1){
         $("table>tbody#"+city).append("<tr id='"+town+"'><td style='color:blue; border:1px solid royalblue'>山區</td><td class='town' style='color:blue; border:1px solid royalblue'>"+town+"("+length+"/"+length0+")<span>(山區:"+stids.map(x=>stid+':'+data['stids'][x].name+','+data['stids'][x].elev+'m').join('; ')+")</span></td></tr>")
      }else if(Object.keys(nearshore_towns).indexOf(city)!=-1&&nearshore_towns[city].indexOf(town)!=-1){
         $("table>tbody#"+city).append("<tr id='"+town+"'><td style='color:green; border:1px solid royalblue'>沿海</td><td class='town' style='color:green; border:1px solid royalblue'>"+town+"("+length+"/"+length0+")<span>(沿海:"+stids.map(x=>stid+':'+data['stids'][x].name+','+data['stids'][x].elev+'m').join('; ')+")</span></td></tr>")
      }else{
         $("table>tbody#"+city).append("<tr id='"+town+"'><td style='color:purple; border:1px solid royalblue'>平地</td><td class='town' style='color:purple; border:1px solid royalblue'>"+town+"("+length+"/"+length0+")<span>(平地:"+stids.map(x=>stid+':'+data['stids'][x].name+','+data['stids'][x].elev+'m').join('; ')+")</span></td></tr>")
      };

      for(var i=i00;i<=i_end;i++){
         var val='-'; 
         var dir='-';  
         var gust='-'; 
         var tim='-';
         var t=new Date(data.times[i]);
         if(i<i_start){
            if(t.getMinutes()!=0){continue}
            if(length==0){
               val=="-"; dir=="-";
            }else{
               xx=tmp.slice(i,i+6); 
               xxx=xx.filter(value=>isFinite(value)); 
               val=(xxx.length==0)?"-":Math.max.apply(null,xxx);

               if(val=="-"){
                  dir="-"
               }else{
                  j=xx.indexOf(val); 
                  if(j!=-1){
                     j=j+i; 
                     jj=tmp1[j].indexOf(val); 
                     t=new Date(data.times[j]); 
                     stid=stids[jj]; 
                     dir=data[param][stid][param2][j];
                  };
               };
               /*
               if(val=="-"){
                  dir="-"
               }else{
                  for(var j=i; j<i+6; j++){
                     jj=tmp1[j].indexOf(val); 
                     if(jj!=-1){
                        t=new Date(data.times[j]); 
                        stid=stids[jj]; 
                        dir=data[param][stid][param2][j]; 
                        break;
                     };
                  };
               };
               */
            };
         }else{
            if(length==0){
               val=="-"; 
               dir=="-";
            }else{
               val=tmp[i]; 
               jj=tmp1[i].indexOf(val)||-1; 
               if(jj!=-1){
                  stid=stids[jj]}val=tmp[i]; 
                  jj=tmp1[i].indexOf(val)||-1; 
                  if(jj!=-1){
                     stid=stids[jj]
                  };
               dir=(val=="-"||jj==-1)?"-":data[param][stid][param2][i];
            };
         };
         ii=(i+6)-(i+6)%6
         if(ii>=n||length==0){
            gust="-"; 
            tim="-"
         }else{
            gust=tmpg[ii]; 
            jj=tmp2[ii].indexOf(gust); 
            if(jj!=-1){
               stidg=stids[jj]; 
               tim=data[param][stidg]["times"][ii]||"-"
            }else{
               stidg="-"; 
               tim='-'
            };
         };
         if(val<0){
            val='-'; 
            dir='-'
         }; 
         if(gust<0){
            gust='-'
         }; 
         scale=ms2scale(val); 
         scaleg=ms2scale(gust)
         cls=set_color(scale,scaleg);
         text  =(isNaN(parseInt(val)))?"<span style='background-color:white;color:red;'>err!</span>":(((scale>=5)?"<font style='font-size:xx-small'><sup style='color:"+set_font_wind2(scale)+"'>"+scale+"</sup><sub style='color:"+set_font_gust2(scaleg)+"'>"+scaleg+"</sub></font>":"")+"<span style='background-color:white;'>"+scale+"G"+scaleg+", "+deg2dir(dir)+" "+val.toFixed(1)+" ms<sup>-1</sup> ("+scale+"級, "+t.toHM()+", "+data['stids'][stid].town+"-"+data['stids'][stid].name+")<br>陣風"+((gust=="-")?gust:(gust+' ms<sup>-1</sup>('+scaleg+'級, '+((tim=="-")?"-":(tim.slice(0,2)+':'+tim.slice(2)))+', '+((stidg=="-")?"-":(data['stids'][stidg].town+'-'+data['stids'][stidg].name)))+")")+"</span>")
  
         $("table>tbody#"+city+">tr:last").append("<td class='"+cls+"' style='border:1px solid royalblue'>"+text+"</td>");
      }; 

      $("table>tbody#"+city+">tr:last").append($("table>tbody#"+city+">tr:last>td:nth-child(2)").clone())
      cls=set_color(scale,'-');
      ii=i_end-(i_end%6); 
      gust=isFinite(tmpg[ii])?tmpg[ii]:"-"; jj=tmp2[ii].indexOf(gust); 
      if(jj!=-1&&isFinite(gust)){
         stidg=stids[jj]; 
         tim=data[param][stidg]["times"][ii]
      }else{
         stidg="-"; 
         tim='-'
      }; 
      scaleg=ms2scale(gust); 
      clsg=set_color('-',scaleg)

      $("table>tbody#"+city+">tr>td.town:last").addClass(set_color(scale,scaleg))
      if(val!="-"){
         $("table>tbody#"+city+">tr:last").append("<td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+val.toFixed(1)+"("+scale+")</td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+deg2dir(dir)+"</td><td class='"+cls+"' style='font-size:smaller; color:"+set_font_wind2(scale)+"'>"+data['stids'][stid].name+"</td>")}else{$("table>tbody#"+city+">tr:last").append("<td>-</td><td>-</td><td>-</td>")
      };
      if(gust!="-"){
         $("table>tbody#"+city+">tr:last").append("<td class='"+clsg+"' style='color:"+set_font_gust2(scaleg)+"'>"+gust.toFixed(1)+"("+scaleg+")</td><td class='"+clsg+"' style='font-size:smaller; color:"+set_font_gust2(scaleg)+"'>"+data['stids'][stidg].name+"</td>")}else{$("table>tbody#"+city+">tr:last").append("<td class='none'>-</td><td>-</td>")
      };

      val="-"; 
      tm=new Date(); 
      gust='-'; 
      tg=new Date()
      xx=tmp.slice(i_today,i_end+1); 
      xxx=xx.filter(value=>isFinite(value)); 
      val=(xxx.length==0)?"-":Math.max.apply(null,xxx);
      j=xx.indexOf(val); 
      if(j!=-1){
         j=j+i_today; 
         jj=tmp1[j].indexOf(val); 
         tm=new Date(data.times[j]); 
         stid=stids[jj];
      };
      xx=tmpg.slice(i_today,i_end+1); 
      xxx=xx.filter(value=>isFinite(value)); 
      gust=(xxx.length==0)?"-":Math.max.apply(null,xxx);
      j=xx.indexOf(gust); 
      if(j!=-1){
         j=j+i_today;
         jj=tmp2[j].indexOf(gust); 
         stidg=stids[jj]; 
         tg=new Date(data.times[j]); 
         tim=data[param][stidg]["times"][j]; 
         tg.setHours(tim.slice(0,2),tim.slice(2))
      };
      scale=ms2scale(val); 
      cls=set_color(scale,'-'); 
      scaleg=ms2scale(gust); 
      clsg=set_color('-',scaleg)
      if(val!="-"&&isFinite(val)){
         $("table>tbody#"+city+">tr:last").append("<td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+val.toFixed(1)+"("+scale+")</td><td class='"+cls+"'>"+deg2dir(dir)+"</td><td class='"+cls+"' style='font-size:smaller; color:"+set_font_wind2(scale)+"'>"+data['stids'][stid].name+"</td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+tm.toHM()+"</td>")}else{$("table>tbody#"+city+">tr:last").append("<td>-</td><td>-</td><td>-</td><td>-</td>")
      };
      if(gust!="-"&&isFinite(gust)){
         $("table>tbody#"+city+">tr:last").append("<td class='"+clsg+"' style='color:"+set_font_gust2(scaleg)+"'>"+gust.toFixed(1)+"("+scaleg+")</td><td class='"+clsg+"' style='font-size:smaller; color:"+set_font_gust2(scale)+"'>"+data['stids'][stidg].name+"</td><td class='"+clsg+"' style='color:"+set_font_gust2(scale)+"'>"+tg.toHM()+"</td>")}else{$("table>tbody#"+city+">tr:last").append("<td class='none'>-</td><td>-</td>><td>-</td>")
      };
   });
};



load_stids=function(city){
   $("tbody#"+city+">tr:not(:first)").remove()
   stids=stids_of_city[city];
   stids.forEach(function(stid){
      tmp=data[param][stid][param1]; 
      tmpg=data[param][stid][param3]; 
      color=(data['stids'][stid].elev>elev_threshold)?'silver':'black'
      $("table>tbody#"+city).append("<tr id='"+stid+"'><td style='border:1px solid black; color:"+color+"'>"+data['stids'][stid].town+"</td><td style='border:1px solid black; color:"+color+"'>"+data['stids'][stid].name+"<span style='color:black'>("+stid+", "+data['stids'][stid].elev.toFixed(0)+"m)</span></td></tr>")

      for(var i=i00;i<=i_end;i++){
         var val='-'; 
         var dir='-'; 
         var gust='-'; 
         var tim='-';
         var t=new Date(data.times[i])
         if(i<i_start){
            if(t.getMinutes()!=0){continue}
            xx=tmp.slice(i,i+6); 
            xx=xx.filter(value=>isFinite(value)); 
            val=(xx.length==0)?"-":Math.max.apply(null,xx);
            j=xx.indexOf(val); 
            if(j!=-1){
               //t=new Date(data.times[j])};  
               t=new Date(data.times[i+j])};  
               dir=data[param][stid][param2][i+j];
            }else{
               val=tmp[i]; dir=data[param][stid][param2][i]
            };
         ii=(i+6)-(i+6)%6
         if(ii>=n){
            gust="-"; tim="-"
         }else{
            gust=tmpg[ii]; 
            tim=data[param][stid]["times"][ii]
         };
         if(val<0){
            val='-'; 
            dir='-'
         }; 
         if(gust<0){
            gust='-'
         }; 
         scale=ms2scale(val); 
         scaleg=ms2scale(gust)
         cls=set_color(scale,scaleg);
         text=(isNaN(parseInt(val)))?"<span style='background-color:white;color:red;'>err!</span>":(((scale>=5)?"<font style='font-size:smaller'><sup style='color:"+set_font_wind(scale)+"'>"+scale+"</sup><sub style='color:"+set_font_gust(scaleg)+"'>"+scaleg+"</sub></font>":"")+"<span style='background-color:white;'>"+scale+"G"+scaleg+", "+deg2dir(dir)+" "+val.toFixed(1)+" ms<sup>-1</sup> ("+scale+"級, "+t.toHM()+", "+data['stids'][stid].town+"-"+data['stids'][stid].name+")<br>陣風"+((gust=="-")?gust:(gust+' ms<sup>-1</sup>('+scaleg+'級, '+((tim=="-")?"-":(tim.slice(0,2)+':'+tim.slice(2)))+', '+((stid=="-")?"-":(data['stids'][stid].town+'-'+data['stids'][stid].name)))+")")+"</span>")
         $("table>tbody#"+city+">tr#"+stid).append("<td class='"+cls+"' style='border:1px solid black'>"+text+"</td>");
      };
      cls=set_color(scale,'-');
      ii=i_end-(i_end%6); 
      gust=tmpg[ii]; 
      scaleg=ms2scale(gust); 
      clsg=set_color('-',scaleg)
      $("table>tbody#"+city+">tr:last>td:nth-child(2)").addClass(set_color(scale,scaleg))
      $("table>tbody#"+city+">tr#"+stid).append($("table>tbody#"+city+">tr#"+stid+">td:nth-child(2)").clone())
      if(val!="-"){
         $("table>tbody#"+city+">tr#"+stid).append("<td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+val.toFixed(1)+"("+scale+")</td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+deg2dir(dir)+"</td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+data['stids'][stid].name+"</td>")}else{$("table>tbody#"+city+">tr#"+stid).append("<td>-</td><td>-</td><td>-</td>")
      };
      if(gust!="-"){
         $("table>tbody#"+city+">tr#"+stid).append("<td class='"+clsg+"' style='color:"+set_font_gust2(scaleg)+"'>"+gust.toFixed(1)+"("+scaleg+")</td><td class='"+clsg+"' style='color:"+set_font_gust2(scaleg)+"'>"+data['stids'][stid].name+"</td>")}else{$("table>tbody#"+city+">tr#"+stid).append("<td>-</td><td>-</td>")
      };
      val="-"; 
      tm=new Date(); 
      gust='-'; 
      tg=new Date()
      xx=tmp.slice(i_today,i_end+1); 
      xxx=xx.filter(value=>isFinite(value)); 
      val=(xxx.length==0)?"-":Math.max.apply(null,xxx);
      j=xx.indexOf(val); 
      if(j!=-1){
         j=j+i_today; 
         tm=new Date(data.times[j]);
      };
      xx=tmpg.slice(i_today,i_end+1); 
      xxx=xx.filter(value=>isFinite(value)); 
      gust=(xxx.length==0)?"-":Math.max.apply(null,xxx);
      j=xx.indexOf(gust); 
      if(j!=-1){
         j=j+i_today; 
         tg=new Date(data.times[j]); 
         tim=data[param][stid]["times"][j]; 
         tg.setHours(tim.slice(0,2),tim.slice(2));
      };
      scale=ms2scale(val); 
      cls=set_color(scale,'-'); 
      scaleg=ms2scale(gust); 
      clsg=set_color('-',scaleg)
      if(val!="-"){
         $("table>tbody#"+city+">tr#"+stid).append("<td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+val.toFixed(1)+"("+scale+")</td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+deg2dir(dir)+"</td><td class='"+cls+"' style='font-size:smaller; color:"+set_font_wind2(scale)+"'>"+data['stids'][stid].name+"</td><td class='"+cls+"' style='color:"+set_font_wind2(scale)+"'>"+tm.toHM()+"</td>")
      }else{
         $("table>tbody#"+city+">tr#"+stid).append("<td>-</td><td>-</td><td>-</td><td>-</td>")
      };
      if(gust!="-"){
         $("table>tbody#"+city+">tr#"+stid).append("<td class='"+clsg+"' style='color:"+set_font_gust(scaleg)+"'>"+gust.toFixed(1)+"("+scaleg+")</td><td class='"+clsg+"' style='font-size:smaller; color:"+set_font_gust(scaleg)+"'>"+data['stids'][stid].name+"</td><td class='"+clsg+"' style='color:"+set_font_gust(scaleg)+"'>"+tg.toHM()+"</td>")
      }else{
         $("table>tbody#"+city+">tr#"+stid).append("<td>-</td><td>-</td>><td>-</td>")
      };
   });
};



/*** click to append town info ***/
$("tbody>tr:nth-child(1)>td.city, tbody>tr:nth-child(1)>td.town").click(function(){
   city=$(this).parent().children('td:first').text()
   if($(this).parent().next().children(":nth-child(2)").text()){
      if($(this).parent().next().css("display")=="none"){
         $("tbody#"+city+">tr").show(); 
         $("table>tbody>tr:nth-child(1)").css("opacity",opacity); 
         $("tbody:not(#"+city+")").hide()
      }else{
         $("tbody#"+city+">tr").not(':first-child').hide(); 
         $("table>tbody>tr:nth-child(1)").css("opacity",1); 
         $("tbody").show()
      };
  }else{
    load_towns(city)
    $("table>tbody>tr:nth-child(1)").css("opacity",opacity)
    $("tbody:not(#"+city+")").hide()
  };

  $("tbody>tr:not(:nth-child(1))>td.town").click(function(){
     city=$(this).parent().parent().attr('id')
     load_stids(city)
  });
});


/* 取得系統時間(for Echarts) */
var WebDate     = now.toYMDHM()
/* End of 取得系統時間(for Echarts) */

$("table").before("<i class='ti-time' style='color:#49C1B6'></i> <font style='font-weight:bold'>最近時間</font>：")
$("table").before("<button id='-24h'><i class='ti-angle-double-left'></i>24h</button>"); 
$("table").before("<button id='-6h'><i class='ti-angle-left'></i>6h</button>"); 
$("table").before("<button id='-1h'><1h</button>");
$("table").before("&nbsp;<font color=#337DFF style='font-weight: bold;'>"+now.toYDHM()+"</font>&nbsp;")
$("table").before("<button id='1h'>1h></button>"); 
$("table").before("<button id='6h'>6h<i class='ti-angle-right'></i></button>"); 
$("table").before("<button id='24h'>24h<i class='ti-angle-double-right'></i></button>");
//$("button").click(function(){
//   now.setTime(now.getTime()+parseFloat($(this).attr('id'))*h2ms); 
//   window.location=(window.location.href).split("?")[0]+"?date="+now.toYMD_H()
//});
//$("button#-1h").after("<button id='10m'><10分</button>");  
//$("button#10m").click(function(){
//   now.setTime(now.getTime()-10*m2ms); 
//   window.location=(window.location.href).split("?")[0]+"?date="+now.toYMD_H()
//});
$("table").before("<button id='yesterday'>0時</button>");  
$("button#yesterday").click(function(){
   now.setHours(0,0,0); 
   window.location=(window.location.href).split("?")[0]+"?date="+now.toYMD_H()
});
$("table").before("&nbsp;<button id='latest'>最新</button>"); 
$("button#latest").click(function(){
   window.location=(window.location.href).split("?")[0]
});
$("table").before("&nbsp;<button id='refresh'>重新整理</button>"); 
$("button#refresh").click(function(){location.reload()});
$("table").before("&nbsp;<button id='hidedata'>隱藏資料</button>")

if(Object.keys(args).indexOf("date")!=-1){
   $("button#latest").text("按此更新")
};

$("table").before("&nbsp;<button id='hidehint'>關閉提示</button>")
$("table").before("&nbsp;&nbsp;&nbsp;<button id='stop_refresh'>停止自動更新</button>");
$("table").before("&nbsp;&nbsp;<i id=info class='ti-na' style='color:#337DFF'></i>&nbsp;<label id=info style='color:#EA007B'></label>")


LatestDate = new Date();
console.log("LatestDate:",LatestDate )
$("i#info").hide()

LABEL_WARN = function(){
   $("label#info").text("指定時間 已超過現在時間!")
   $("i#info").show()
   window.setTimeout(function(){
      $("label#info").text("")
      $("i#info").hide()
   },2000);
};

$("button").click(function(){
   if( !isNaN(parseFloat($(this).attr('id'))) &&  $(this).attr('id')!=="10m"  ){
     t_Date = new Date(now.getTime()+parseFloat($(this).attr('id'))*h2ms)
     if( t_Date <= LatestDate ){
        now.setTime(now.getTime()+parseFloat($(this).attr('id'))*h2ms);
        window.location=(window.location.href).split("?")[0]+"?date="+now.toYMD_H()
     }else{
        LABEL_WARN()
     };
   };
   //now.setTime(now.getTime()+parseFloat($(this).attr('id'))*h2ms);
   //window.location=(window.location.href).split("?")[0]+"?date="+now.toYMD_H()
});
$("button#-1h").after("<button id='10m'><10分</button>");
$("button#10m").click(function(){
   now.setTime(now.getTime()-10*m2ms);
   window.location=(window.location.href).split("?")[0]+"?date="+now.toYMD_H()
});


$("button#stop_refresh").click(function(){
   $(this).text("已停止自動更新");
   $(this).css("color","RED");
   $(this).attr("disabled",true);
   window.stop()
});

$("button#hidehint").click(function(){$("span").hide()})

$("button#hidedata, thead>tr:first>th:contains(風力), thead>tr:first>th:contains(陣風)").one("click",function(){
   $("table>thead>tr:last>th").off("click")
   $('tbody>tr>td:nth-last-child(n+13):not(:nth-child(-n+2)), thead>tr:first>th:nth-last-child(n+5):not(:nth-child(-n+2)), thead>tr:last>th:nth-last-child(n+13), tfoot>tr:first>th:nth-last-child(n+5):not(:nth-child(-n+2)), tfoot>tr:last>th:nth-last-child(n+13)').remove();

   $("thead>tr:last>th").click(function(){
      var i=$(this).index()+3; 
      if(i!=3&&i!=6&&i!=8&&i!=12){return};
      var x=tmp=new Array()
      $("tbody>tr:visible>td:nth-child("+i+")").each(function(){
         x.push([$(this).text().split("(")[0],$(this).parent().prop("outerHTML")])
      });
      $("tbody").remove();
      $("table").append("<tbody></tbody>")
      x.sort((x,y)=>(isFinite(y[0])?y[0]:-Infinity)-(isFinite(x[0])?x[0]:-Infinity)).forEach(function(x){
         $("table>tbody").append(x[1])
      });
      $("tbody>tr>td:nth-child(1)").contextmenu(function(e){e.preventDefault(); $(this).parent().remove()})
   })
   $("button#hideall, button#hidedata").remove()
   $("tbody>tr>td:nth-child(1)").contextmenu(function(e){
      e.preventDefault(); 
      $(this).parent().remove()
   });
   $("tbody>tr>td.city, tbody>tr>td.town").off("click")
   window.stop(); 
   $("button#refresh").css("background","rgba(64,255,0,0.5)")
});

$("button").attr("style","color:black;background-color: white;border: 1px solid darkgray;border-radius: 4px;height: 23px;");
$("button#latest").css('background','rgba(255,0,0,0.3)');


$("button").hover(function(){
     $(this).css("border-color", "MediumVioletRed");
  }, function(){
     $(this).css("border-color", "darkgray");
});

if(Object.keys(args).indexOf("date")!=-1){
   $("button#stop_refresh").trigger("click")
   $("button#stop_refresh").attr("style","color:red;background-color: white;border: 1px solid darkgray;border-radius: 4px;height: 23px;border-color:MediumVioletRed");
};




/************************************************************************/
$("table>thead>tr:last>th").click(function(){
   var n=$("table>tbody:first>tr:first>td").length; 
   var m=12;
   var x=tmp=new Array()
   i=$(this).index()+3;
   if(i>=(n-m)){
      i=i+1;
      $("tbody>tr:visible>td:nth-child("+i+")").each(function(){
         x.push([$(this).text().split("(")[0],$(this).parent().html()])
      });
   }else{
      $("tbody>tr:visible>td:nth-child("+i+")").each(function(){
         x.push([$(this).text()=="err!"?"-":$(this).text().split("陣風")[1].split("ms")[0],$(this).parent().html()])
      });
   };// alert(i+'/'+n+'/'+m)

   $("tbody").remove()
   $("table").append("<tbody></tbody>")
   x.sort((x,y)=>(isFinite(y[0])?y[0]:-Infinity)-(isFinite(x[0])?x[0]:-Infinity)).forEach(function(x){
      $("tbody").append("<tr>"+x[1]+"</tr>")
   })
   window.stop(); 
   $("button#refresh").css("background","rgba(64,255,0,0.5)")
});





/*** Add Echart Plot Var and Map ***/
var stids_of_city_R = Reform_stids_of_city(stids_of_city)
var stids_of_town_R = Reform_stids_of_town(stids_of_town)

$("tbody>tr>td").click(function(){
   ii=$(this).index()
   console.log( "WebDate:",WebDate ) 
   console.log( "click index:", ii)   
 
   var click_shift = 0
   var fid_last = parseInt($("tbody tr:first").find("td:last").index())- click_shift
   var thii = parseInt(ii)
   var id_sp_1 = fid_last - (3+2+4+3)
   var id_sp_2 = fid_last - (  2+4+3) 
   var id_sp_3 = fid_last - (    4+3)
   var id_sp_4 = fid_last - (      3)

   if(thii > 1 && thii < id_sp_1){
      console.log("#取得Title@主表格區")
      /* 主表格區 */
      var target_th_name = "th:nth-child("+parseInt(parseInt(ii)-1)+")"
      var target_datetime = $("thead tr:nth-child(2)").find(target_th_name).find("span").text()
      var param_name = "wind"
      console.log("target_datetime:",target_datetime)
      console.log("param_name:",param_name)
   }else if(thii > 1){
      console.log("#取得Title@非主表格區")
      /* 非主表格區 */
      if(thii>id_sp_1 && thii<=id_sp_2){
         HeadTh_id = 3 + 1
      }else if(thii>id_sp_2 && thii<=id_sp_3){
         HeadTh_id = 2 + 1
      }else if(thii>id_sp_3 && thii<=id_sp_4){
         HeadTh_id = 1 + 1
      }else if(thii>id_sp_4 && thii<=fid_last){
         HeadTh_id = 0 + 1
      };
      var target_th_name = "th:nth-last-child("+parseInt( parseInt(HeadTh_id)  )+")"
      var th_text = $("thead tr").find(target_th_name).text()
      if( th_text.indexOf("目前")>=0 ){
         var param_name = "wind"
         var target_datetime = WebDate
      }else if( th_text.indexOf("前1時陣風")>=0){
         var param_name = "wind"
         var t_date_obj = new Date()
         t_date_obj.setTime( now.getTime() - (1*60*60*1000) )
         var target_datetime = t_date_obj.toYMDHM() 
      }else if( th_text.indexOf("最大風力")>=0){
         var param_name = "statistics"
         var target_datetime = WebDate
      }else if( th_text.indexOf("最大陣風")>=0){
         var param_name = "statistics"
         var target_datetime = WebDate
      };
      console.log("target_datetime:",target_datetime)
      console.log("param_name:",param_name)
   };

   Flag_Comb_Show = false

   if( thii > 1 && thii < id_sp_1 ){
      console.log("#主表格#")
      var Flag_Select = "MainTable"
      var Flag_Select_Date = Reform_Date(target_datetime)
      Return_Data = get_Data_MainTable( data["times"].indexOf(Flag_Select_Date) )  
   }else if( (thii > id_sp_1) && (thii<= id_sp_2) ){
      console.log("#目前表格#")
      var Flag_Select = "NowTable"
      var Flag_Select_Date = target_datetime
      Return_Data = get_Data_NowTable( data["times"].indexOf(Flag_Select_Date))
   }else if( (thii > id_sp_2) && (thii<= id_sp_3) ){
      console.log("#前一小時陣風#")
      var Flag_Select = "LastHourGustTable"
      var Flag_Select_Date = target_datetime
      Return_Data = get_Data_LastHourGustTable( data["times"].indexOf(Flag_Select_Date) )
   }else if( (thii > id_sp_3) && (thii<= id_sp_4) ){
      console.log("#今日最大風力表格#")
      var Flag_Select = "TodayMaxTable"
      var Flag_Select_Date = target_datetime
      Return_Data = get_Data_TodayMaxTable( data["times"].indexOf(Flag_Select_Date))
   }else if( (thii > id_sp_4) && (thii<= fid_last) ){
      console.log("#金日最大陣風表格#")
      var Flag_Select = "TodayMaxGustTable"
      var Flag_Select_Date = target_datetime
      Return_Data = get_Data_TodayMaxGustTable( data["times"].indexOf(Flag_Select_Date) )
   }else{
      console.log("#其他#")
      var Flag_Select = "NONE"
      return
   };
   console.log("表格區選擇:",Flag_Select,"Date:",Flag_Select_Date)


   /* Echarts Plot */
   if( ii >=1){

      img_dir='/static/data/IMG/Hazard_Colors/';
      var Browser_Height = document.body.clientHeight
      var Table_Height   = $("table").height()

      xx=600; yy=750;

      if(Browser_Height*0.9 < yy){
         xx = xx * 0.8
         yy = yy * 0.8
      };
      $("div#main").remove()
    
      if(!$("div#main").length){
         xx=600; yy=750;
         xx=600; yy=730;

         if(Browser_Height*0.9 < yy){
            xx = xx * 0.8
            yy = yy * 0.8
         };
         if( window.innerWidth < 400){
            xx = window.innerWidth * 0.8
            yy = xx * 730 / 600
         };
         
         xx_main = 600
         yy_main = 770

         xx_main = xx
         yy_main = yy +30

         $("table").after("<div id='main' style='z-index:10;right:1%; top:10%;width:"+xx_main+"px;height:"+yy_main+"px;margin-left:0px;margin-right:0px;border:1px solid #ccc;background-color: white;position: absolute;box-shadow: darkgrey 1px 1px 10px 3px;'><div id='mydivheader'  style='height:30px;padding:0px;'>&nbsp;<label id='header_title'></label>&nbsp;<img id='switch' style='float:left' src='"+img_dir+"icons_repeat.png' width='0px' height='0px'><img id='closed' style='float:right'  src='"+img_dir+"icons_close.png' width='30px' height='30px'>"+"<div id='taiwan_map' style='z-index:10;width:"+xx+"px;height:"+yy+"px;margin:0 auto;position: absolute;top:30px;left:0px;display: block;background-color: white;'></div><div id='city_map' style='z-index:10;width:"+xx+"px;height:"+yy+"px;margin:0 auto;position: absolute;display: none;background-color: white;top:30px;left:0px;'></div></div></div>");
         $("div#mydivheader").attr("style","height:30px;padding: 0px;cursor: move;z-index: 10;background-color: #2196F3;color: #fff;")

      };

      Echarts_MAP( {"FData":Return_Data[0],"STD_Data":Return_Data[1]}, target_datetime, false , true, true,Flag_Select)
   };



   Phone_drag(document.getElementById("main"));
   dragElement(document.getElementById("main"));
   $("#closed").click(function(){
      $("#main").remove()
   });
   $("#switch").click(function(){
      img=$("#mian>img:last").attr("src");
      if(img.indexOf("IMG2")==-1){
         $("#mydiv>img:last").remove(); 
      }else{
         $("#mydiv>img:last").remove(); 
      }
   });
 
});


/*** End of Add Echart Plot Var and Map ***/


</script>

</body>
</html>
